<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Blinkybike : ">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Blinkybike</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/NicolasBesson/BlinkyBike">View on GitHub</a>

          <h1 id="project_title">Blinkybike</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/NicolasBesson/BlinkyBike/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/NicolasBesson/BlinkyBike/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="blinky-bike" class="anchor" href="#blinky-bike" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Blinky Bike</h1>

<p>The Blinky Bike project is an ultimate solution to add lightning system to any Bike, ( and electric Bike) using a 5V power bank or the bike Battery. It relies on NeoPixel LEDs (WS8212) flexible stripes. The system based on an Atmel ATTiny 85 micro-controller, allows different light modes that can be selected using two water proof switches (One for the Left hand and one for the Right hand).</p>

<h2>
<a id="device-usage" class="anchor" href="#device-usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Device Usage</h2>

<p>The device Left and Right buttons are the only interface with the system allowing to :</p>

<ul>
<li>Turn ON and OFF the light system</li>
<li>Turn Left and Right indicator</li>
</ul>

<p>Switches operations are :</p>

<table>
<thead>
<tr>
<th align="center">Left Button</th>
<th align="center">Right Button</th>
<th align="left">Action</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Release</td>
<td align="center">Release</td>
<td align="left">Nothing</td>
</tr>
<tr>
<td align="center">Short</td>
<td align="center">Release</td>
<td align="left">Turn Left</td>
</tr>
<tr>
<td align="center">Release</td>
<td align="center">Short</td>
<td align="left">Turn Right</td>
</tr>
<tr>
<td align="center">Long</td>
<td align="center">Long</td>
<td align="left">Turn Light ON or OFF</td>
</tr>
</tbody>
</table>

<p><img src="/Pictures/Button_Left1.jpg" alt="BlinkyBike Left Button" title="Left Button"> <img src="/Pictures/Button_Right1.jpg" alt="BlinkyBike Right Button" title="Right Button"></p>

<h2>
<a id="leds-stripes" class="anchor" href="#leds-stripes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LEDs stripes</h2>

<p>The system is based on a Front LED flexible stripe and two Rear LED Flexible Stripe, one for the Left and one for the Right indicator.
The Front and Rear LEDs stripes are composed of a total of 30 LEDs, 8 for the Front and 11 for each Rear stripes.</p>

<p><img src="/Pictures/FrontBack_Stripes_On.jpg" alt="BlinkyBike Schematic" title="Front and Rear Stripes"></p>

<h2>
<a id="power-consideration" class="anchor" href="#power-consideration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Power consideration</h2>

<p>The system is designed to be power friendly with the e-Bike battery, as the battery might not be able to provide the full power required to have all the LEDs turned on at the same time. As the NeoPixel RGB LEDs (WS8212) consumes 20 mA per color channel, with a total of 60 mA (3 channels * 20 mA) when the LED is turned full bright White color (Red = 255, Green = 255, Blue = 255). The challenge is to not be over 500 mA (power limit supplied by the Battery on my e-Bike). I have applied a secure level set to 450 mA maximum. Leading then to a limit of 7 LEDs active at a time.
Having only 7 LEDs is really limitating for a bike light system, so the solution is to multiplex the LEDs and ensure that only those 7 LEDs are on, while all the others are off. If the multiplexing switch is performed fast enough, it should be possible to make it not visible for a Human eye. 
Therefore, the ATTiny firmware is taking care of the current limitation by switching on and off the LEDs, remaining only 7 LEDs on at a time, giving a maximum power consumption for the LEDs of 420 mA.</p>

<p>This can be adjusted by editing the <a href="/BlinkyBike/BlinkyBike/Stripes.h">Stripes.h</a> file :</p>

<div class="highlight highlight-source-c"><pre><span class="pl-c">// Number of LED</span>
#<span class="pl-k">define</span> <span class="pl-en">LED_STRIPE_FRONT_ON</span>   <span class="pl-c1">3</span>
#<span class="pl-k">define</span> <span class="pl-en">LED_STRIPE_REAR_ON</span>    <span class="pl-c1">2</span></pre></div>

<h2>
<a id="light-animation" class="anchor" href="#light-animation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Light animation</h2>

<p>When riding a bike a night, and having fix light color is not the optimal solution to be visible by drivers. Therefore having some flashing, blinking mode for the lights gives more visibility and make your bike more attractive. When light is On, the Front stripe displays a fast blinking animation at a frequency of about 10 Hz.
When turning left or right, the visual animation is orange and blinky.
So having a flexible software architecture is a must have. With AnimationStep and Animation it is fairly simple to describe an animation. </p>

<p>The types are described as following :</p>

<div class="highlight highlight-source-c"><pre><span class="pl-k">struct</span> AnimationStepFront
{
    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> StepDuration; <span class="pl-c">// Step Duration in ms</span>
    PixelColor Pixels[<span class="pl-c1">1</span>];       <span class="pl-c">// Step Pixels color</span>
};

<span class="pl-k">struct</span> AnimationFront
{
    AnimationStepFront *animationStep;  <span class="pl-c">// Front Step</span>
    AnimationFront *nextAnimation;      <span class="pl-c">// Next Front animation</span>
};</pre></div>

<p>And an animation is described as following :</p>

<div class="highlight highlight-source-c"><pre>AnimationStepFront stepWhiteFront = { <span class="pl-c1">150</span>,
{ 
    <span class="pl-c1">COLOR_PIXEL</span>(WHITE) 
}
};

AnimationStepFront stepBlackFront = { <span class="pl-c1">50</span>,
{ 
    <span class="pl-c1">COLOR_PIXEL</span>(BLACK) 
}
};

<span class="pl-c">/* Animations for Front */</span>
AnimationFront animationFrontOff = { &amp;stepBlackFront, &amp;animationFrontOff };
AnimationFront animationFrontOn = { &amp;stepWhiteFront, &amp;animationFrontOn };
</pre></div>

<h1>
<a id="building-the-hardware" class="anchor" href="#building-the-hardware" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building the Hardware</h1>

<p>The hardware is minimalistic as the Neopixel and ATTiny are embedding all the discrete components that you normally use to drive RGB LED.</p>

<p><img src="/Hardware/BlinkyBike_sch%C3%A9ma.png" alt="BlinkyBike Schematic" title="Schematic"></p>

<p>The Blinky Bike system is built using the following hardware :</p>

<ul>
<li>AtTiny85</li>
<li>NeoPixel Stripes

<ul>
<li>1x 8 LEDs</li>
<li>2x 11 LEDs</li>
</ul>
</li>
<li>3x 380 Ohms resistor</li>
<li>1x 10 kOhms resistor</li>
<li>1x 1000 ÂµF capacitor</li>
<li>2x water proof switches</li>
</ul>

<p>You won't find any PCB layout, as I'm using through hole prototyping board, developed with Fritzing software.</p>

<p><img src="/Hardware/BlinkyBike_bb.png" alt="Prototyping board" title="Prototyping board"></p>

<h1>
<a id="building-the-software" class="anchor" href="#building-the-software" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building the Software</h1>

<p>The ATTiny 85 is a really cool Micro Controller that have 8 KB of Flash and 512 B of RAM to run any kind of C or C++ software. This gives some space to run a simple software and for this reason some optimization are required.</p>

<p>The project has been developed in C++ (C++11) in order to reuse and give more flexibility in case of development of new features. It is required to use the VisualMicro extension for Visual Studio 2013 in order to build the project.</p>

<p>AdaFruit is providing a library to drive the Neopixel devices, that you can directly integrate in your Arduino IDE. But this code has been designed to support various modes in order to address major use cases. The source code repository is containing an optimized version that works only with the Neopixels that I have selected and might not work if you choose a different one.</p>

<p>The Neopixel device requires specific timings that can't be reach when using the ATTiny 85 in 4 MHz (its default configuration) and therefore requires to use the 8 Mhz mode. So it is mandatory to burn the correct fuses in the ATTIny before deploying the firmware. This can be done from the Arduino IDE by selecting the ATTiny 85 target and selecting the clock frequency to 8 MHz (internal).</p>

<h2>
<a id="tools" class="anchor" href="#tools" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tools</h2>

<p>Before starting some tools are required :</p>

<ul>
<li><a href="https://www.visualstudio.com/en-us/downloads/download-visual-studio-vs.aspx">Visual Studio Community 2013 with Update 5</a></li>
<li>
<a href="http://www.visualmicro.com/">VisualMicro</a> a VS2013 plugin for Arduino development</li>
<li>USBTinyISP</li>
</ul>

<h2>
<a id="compilation" class="anchor" href="#compilation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compilation</h2>

<p>The source code compiles in VS2013 through the VisualMicro plugin.</p>

<h2>
<a id="programming" class="anchor" href="#programming" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Programming</h2>

<p>The ATTiny 85 micro controller can be programmed using the USBTinyISP programmer.</p>

<h1>
<a id="assembling" class="anchor" href="#assembling" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Assembling</h1>

<h2>
<a id="left-and-right-button" class="anchor" href="#left-and-right-button" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Left and Right Button</h2>

<p><img src="/Pictures/Button_Left1.jpg" alt="BlinkyBike Left Button" title="Left Button"> <img src="/Pictures/Button_Right1.jpg" alt="BlinkyBike Right Button" title="Right Button">
<img src="/Pictures/Button_Left2.jpg" alt="BlinkyBike Left Button" title="Left Button"> <img src="/Pictures/Button_Right2.jpg" alt="BlinkyBike Right Button" title="Right Button"></p>

<h2>
<a id="pcb" class="anchor" href="#pcb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>PCB</h2>

<p><img src="/Pictures/BlinkyBike_PCB.jpg" alt="BlinkyBike PCB" title="PCB"></p>

<h2>
<a id="casing" class="anchor" href="#casing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Casing</h2>

<p><img src="/Pictures/BlinkyBike_Casing.jpg" alt="BlinkyBike Casing" title="Casing"></p>

<h2>
<a id="full-system" class="anchor" href="#full-system" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Full System</h2>

<p><img src="/Pictures/BlinkyBike_Assembled.jpg" alt="BlinkyBike Assembled" title="Assembled"></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Blinkybike maintained by <a href="https://github.com/NicolasBesson">NicolasBesson</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
